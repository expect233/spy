# Fix: cannot create room

## ğŸš¨ ç·Šæ€¥ä¿®å¾©

ä¿®å¾©äº†ã€Œç„¡æ³•å‰µå»ºæˆ¿é–“ã€çš„é—œéµå•é¡Œï¼Œç¾åœ¨ç”¨æˆ¶å¯ä»¥æˆåŠŸå‰µå»ºæˆ¿é–“ä¸¦é–‹å§‹éŠæˆ²ã€‚

## ğŸ” å•é¡Œè¨ºæ–·

### åŸå› åˆ†æ
1. **API è·¯ç”±å•é¡Œ**ï¼šé¦–é çµ„ä»¶ä½¿ç”¨ `clientStore`ï¼ˆæœ¬åœ°å­˜å„²ï¼‰ï¼Œä½† API å®¢æˆ¶ç«¯æŒ‡å‘ Firebase Functions
2. **Firebase Functions é™åˆ¶**ï¼šFunctions éœ€è¦ Blaze ä»˜è²»æ–¹æ¡ˆæ‰èƒ½éƒ¨ç½²
3. **éŒ¯èª¤è™•ç†ä¸è¶³**ï¼šç¼ºä¹ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æç¤ºå’Œé‡è©¦æ©Ÿåˆ¶

### å¾©ç¾æ­¥é©Ÿ
- åœ¨é¦–é é»ã€Œå»ºç«‹æˆ¿é–“ã€
- è§€å¯Ÿ API/è³‡æ–™åº«æ˜¯å¦æœ‰æ–°æˆ¿é–“å»ºç«‹èˆ‡å›å‚³ code
- çµæœï¼šAPI èª¿ç”¨å¤±æ•—ï¼Œç„¡æ³•å‰µå»ºæˆ¿é–“

## ğŸ›  ä¿®å¾©æ–¹æ¡ˆ

### 1. æ·»åŠ  Next.js API Routes
å‰µå»ºæœ¬åœ°é–‹ç™¼ç”¨çš„ API ç«¯é»ï¼š
- `POST /api/rooms` - å‰µå»ºæˆ¿é–“
- `POST /api/rooms/[code]/join` - åŠ å…¥æˆ¿é–“  
- `GET /api/rooms/[code]` - ç²å–æˆ¿é–“ä¿¡æ¯
- `POST /api/log` - éŒ¯èª¤æ—¥èªŒè¨˜éŒ„

### 2. ä¿®å¾©é¦–é çµ„ä»¶
- æ›´æ–° `app/page.tsx` ä½¿ç”¨ `apiClient` è€Œé `clientStore`
- æ·»åŠ å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦ UI
- æ·»åŠ  `data-testid` å±¬æ€§æ”¯æ´ E2E æ¸¬è©¦
- å¯¦ç¾éŒ¯èª¤æ—¥èªŒä¸Šå ±

### 3. æ”¹é€²ç”¨æˆ¶é«”é©—
- é¡¯ç¤ºå¯é‡è©¦çš„éŒ¯èª¤ UI
- éŒ¯èª¤è¨Šæ¯ä¸Šå ±åˆ° console.error å’Œ /api/log
- æ·»åŠ è¼‰å…¥ç‹€æ…‹å’Œç¦ç”¨æŒ‰éˆ•

## ğŸ§ª æ¸¬è©¦è¦†è“‹

### E2E æ¸¬è©¦ (`e2e/create-room.spec.ts`)
- âœ… æˆåŠŸå‰µå»ºæˆ¿é–“ä¸¦å°èˆªåˆ°æˆ¿é–“é é¢
- âœ… ç©ºåç¨±æ™‚é¡¯ç¤ºéŒ¯èª¤
- âœ… API å¤±æ•—æ™‚é¡¯ç¤ºé‡è©¦ UI
- âœ… ç¶²è·¯éŒ¯èª¤è™•ç†
- âœ… éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
- âœ… å¤šç©å®¶åŠ å…¥æˆ¿é–“æµç¨‹

### API æ¸¬è©¦ (`scripts/test-api.js`)
- âœ… å‰µå»ºæˆ¿é–“ API
- âœ… åŠ å…¥æˆ¿é–“ API  
- âœ… ç²å–æˆ¿é–“ä¿¡æ¯ API
- âœ… å®Œæ•´æµç¨‹æ¸¬è©¦

### é‹è¡Œæ¸¬è©¦
```bash
# API æ¸¬è©¦
npm run test:api

# E2E æ¸¬è©¦
npm run test:e2e

# å–®å…ƒæ¸¬è©¦
npm run test
```

## ğŸ“Š æ¶æ§‹åœ–

```mermaid
graph TD
    A[ç”¨æˆ¶é»æ“Šå‰µå»ºæˆ¿é–“] --> B[app/page.tsx]
    B --> C[apiClient.createRoom]
    C --> D{ç’°å¢ƒåˆ¤æ–·}
    D -->|é–‹ç™¼ç’°å¢ƒ| E[/api/rooms Next.js API]
    D -->|ç”Ÿç”¢ç’°å¢ƒ| F[Firebase Functions]
    E --> G[å…§å­˜å­˜å„² Map]
    F --> H[Firestore]
    G --> I[è¿”å› roomCode + hostToken]
    H --> I
    I --> J[å‰µå»ºç©å®¶æœƒè©±]
    J --> K[å°èˆªåˆ° /room/[code]]
```

## ğŸ—ƒ è³‡æ–™æ¨¡å‹

### Room
```typescript
interface Room {
  code: string;           // 6ä½æˆ¿é–“ä»£ç¢¼
  hostId: string;         // æˆ¿ä¸»ID
  players: Player[];      // ç©å®¶åˆ—è¡¨
  config: RoomConfig;     // éŠæˆ²é…ç½®
  state: GameState;       // éŠæˆ²ç‹€æ…‹
  createdAt: number;      // å‰µå»ºæ™‚é–“
  updatedAt: number;      // æ›´æ–°æ™‚é–“
}
```

### Player
```typescript
interface Player {
  id: string;             // ç©å®¶ID
  name: string;           // ç©å®¶åç¨±
  isHost: boolean;        // æ˜¯å¦ç‚ºæˆ¿ä¸»
  connected: boolean;     // é€£ç·šç‹€æ…‹
  createdAt: number;      // åŠ å…¥æ™‚é–“
}
```

### Token
```typescript
interface Token {
  playerId: string;       // ç©å®¶ID
  roomCode: string;       // æˆ¿é–“ä»£ç¢¼
  isHost: boolean;        // æ˜¯å¦ç‚ºæˆ¿ä¸»
  createdAt: number;      // å‰µå»ºæ™‚é–“
}
```

## ğŸ”§ API ç«¯é»

| æ–¹æ³• | è·¯å¾‘ | æè¿° | è«‹æ±‚ | å›æ‡‰ |
|------|------|------|------|------|
| POST | `/api/rooms` | å‰µå»ºæˆ¿é–“ | `{hostName: string}` | `{code: string, hostToken: string}` |
| POST | `/api/rooms/[code]/join` | åŠ å…¥æˆ¿é–“ | `{name: string}` | `{playerId: string, token: string}` |
| GET | `/api/rooms/[code]` | ç²å–æˆ¿é–“ | - | `Room` |
| POST | `/api/log` | éŒ¯èª¤æ—¥èªŒ | `{level, message, error, timestamp}` | `{success: boolean}` |

## ğŸ”’ å®‰å…¨è€ƒé‡

### è¼¸å…¥é©—è­‰
- ç©å®¶åç¨±ï¼š1-20 å­—å…ƒï¼Œéç©º
- æˆ¿é–“ä»£ç¢¼ï¼š6 ä½è‹±æ•¸å­—
- æˆ¿é–“å®¹é‡ï¼šæœ€å¤š 8 äºº

### éŒ¯èª¤è™•ç†
- API éŒ¯èª¤çµ±ä¸€æ ¼å¼ï¼š`{error: string}`
- ç¶²è·¯éŒ¯èª¤è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤è¨Šæ¯

### é€Ÿç‡é™åˆ¶
- å‰µå»ºæˆ¿é–“ï¼šç„¡é™åˆ¶ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
- åŠ å…¥æˆ¿é–“ï¼šç„¡é™åˆ¶ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
- éŒ¯èª¤æ—¥èªŒï¼šå¿½ç•¥å¤±æ•—

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–

### å…§å­˜å­˜å„²
- ä½¿ç”¨ Map çµæ§‹å¿«é€ŸæŸ¥æ‰¾
- æˆ¿é–“å’Œ Token åˆ†é›¢å­˜å„²
- è‡ªå‹•æ¸…ç†éæœŸæ•¸æ“šï¼ˆTODOï¼‰

### å‰ç«¯å„ªåŒ–
- æŒ‰éˆ•ç¦ç”¨é˜²æ­¢é‡è¤‡æäº¤
- è¼‰å…¥ç‹€æ…‹æå‡ç”¨æˆ¶é«”é©—
- éŒ¯èª¤ç‹€æ…‹æœ¬åœ°ç®¡ç†

## ğŸš€ éƒ¨ç½²èªªæ˜

### æœ¬åœ°é–‹ç™¼
```bash
npm run dev
# è¨ªå• http://localhost:3000
# å‰µå»ºæˆ¿é–“åŠŸèƒ½æ­£å¸¸å·¥ä½œ
```

### ç”Ÿç”¢éƒ¨ç½²
1. å‡ç´š Firebase åˆ° Blaze æ–¹æ¡ˆ
2. éƒ¨ç½² Functionsï¼š`firebase deploy --only functions`
3. æ›´æ–°ç’°å¢ƒè®Šæ•¸æŒ‡å‘ Functions

## âœ… Definition of Done

- [x] ä¿®å¾©ï¼šå¯ä»¥æˆåŠŸã€Œå‰µå»ºæˆ¿é–“ã€ï¼Œä¸¦å–å¾— `{code, hostToken}`
- [x] å¯é€²å…¥ `/room/[code]` é é¢
- [x] æ·»åŠ ç«¯åˆ°ç«¯ E2E æ¸¬è©¦ï¼šå‰µå»ºæˆ¿é–“â†’æ”¶åˆ° codeâ†’æˆ¿é–“é é¢è¼‰å…¥
- [x] å®¢æˆ¶ç«¯å»ºæˆ¿å¤±æ•—æ™‚é¡¯ç¤ºå¯é‡è©¦çš„éŒ¯èª¤ UI
- [x] éŒ¯èª¤ä¸Šå ±åˆ° `console.error` èˆ‡ `/api/log`
- [x] README æ›´æ–°ã€Œå·²ä¿®å¾©ï¼šç„¡æ³•å‰µå»ºæˆ¿é–“ã€
- [x] API æ¸¬è©¦è…³æœ¬é©—è­‰åŠŸèƒ½
- [x] PR æ–‡æª”åŒ…å«æ¶æ§‹åœ–èˆ‡è³‡æ–™æ¨¡å‹

## ğŸ”„ å¾ŒçºŒå·¥ä½œ

1. **å‡ç´šåˆ° Firebase Functions**ï¼ˆéœ€ä»˜è²»æ–¹æ¡ˆï¼‰
2. **æ·»åŠ å¯¦æ™‚åŒæ­¥åŠŸèƒ½**ï¼ˆFirestore ç›£è½ï¼‰
3. **å¯¦ç¾å®Œæ•´éŠæˆ²é‚è¼¯**ï¼ˆç™¼è¨€ã€æŠ•ç¥¨ã€å‹è² åˆ¤å®šï¼‰
4. **æ·»åŠ èŠå¤©å®¤åŠŸèƒ½**
5. **å¯¦ç¾é ­åƒç³»çµ±**
6. **æ·»åŠ æˆ¿ä¸»æ§åˆ¶åŠŸèƒ½**

---

**ğŸ® ç¾åœ¨ç”¨æˆ¶å¯ä»¥æˆåŠŸå‰µå»ºæˆ¿é–“ä¸¦é–‹å§‹éŠæˆ²äº†ï¼**
